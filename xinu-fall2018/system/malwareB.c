/*  malwareB.c - malware */

#include <xinu.h>

/*------------------------------------------------------------------------------------------
 *  malwareB  -  Hijacking a process via stack smashing without any disruption on myprogA
 *------------------------------------------------------------------------------------------
 */

void malwareB(void)
{
    /*
     * Here, we must save all registers and eflags used in myprogA()
     * because this is not a normal function call
     */

    asm volatile ("pushfl\n\t"
                  "pushal\n\t");

    kprintf("\nmalwareB() hijacks succeeded!\n");
    kprintf("\nNow, myprogA will continue running and printing its stack parameters.\n");
    kprintf("\nThe parameters would remain the same as previous\n\n");

    /*
     * Before malwareB() returns, we must move the original address from
     * proctab[ppid].prstkbase - 48 to proctab[ppid].prstkbase - 52,
     * in order to remain the %esp register unchanged in myprogA().
     */

    asm volatile ("popal\n\t"
                  "popfl\n\t"
                  "movl %ebp, %esp\n\t"
                  "popl %ebp\n\t"
                  "pushl (%esp)\n\t"
                  "ret");
}
