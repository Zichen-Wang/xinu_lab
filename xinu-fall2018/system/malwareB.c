/*  malwareB.c - malware */

#include <xinu.h>

/*------------------------------------------------------------------------------------------
 *  malwareB  -  Hijacking a process via stack smashing without any disruption on myprogA
 *------------------------------------------------------------------------------------------
 */

void malwareB(void)
{

    kprintf("\nmalwareB() hijacks succeeded!\n");
    kprintf("\nNow, myprogA will continue running and printing its stack parameters.\n");
    kprintf("\nThe parameters would remain the same as previous.\n\n");


    /*
     * From the assembly code of malwareB.s, I found that %ebx which is callee saved has been changed,
     * so, we should restore it before malwareB() returns.
     * Moreover, we must move the original address from
     * proctab[ppid].prstkbase - 48 to proctab[ppid].prstkbase - 52,
     * in order to remain the %esp register unchanged in myprogA().
     */

    asm volatile ("movl -4(%ebp), %ebx\n\t"
                  "movl %ebp, %esp\n\t"
                  "popl %ebp\n\t"
                  "pushl (%esp)\n\t"
                  "ret");
}
