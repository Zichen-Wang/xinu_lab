/*  malwareB.c - malware */

#include <xinu.h>

/*------------------------------------------------------------------------------------------
 *  malwareB  -  Hijacking a process via stack smashing without any disruption on myprogA
 *------------------------------------------------------------------------------------------
 */

void malwareB(void)
{
    kprintf("\nmalwareB() hijack succeeded!\n");
    kprintf("\nNow, myprogA will continue running and printing its stack parameters.\n\n");

    /* Before malwareB returns, we must move the original address from
     * proctab[ppid].prstkbase - 48 to proctab[ppid].prstkbase - 52,
     * in order to maintain the esp unchanged in myprogA()
     */

    asm volatile ("movl %ebp, %esp\n\t"
                  "popl %ebp\n\t"
                  "pushl (%esp)\n\t"
                  "ret");
}
