/*  malwareB.c - malware */

#include <xinu.h>

/*------------------------------------------------------------------------------------------
 *  malwareB  -  Hijacking a process via stack smashing without any disruption on myprogA
 *------------------------------------------------------------------------------------------
 */

void malwareB(void)
{

    kprintf("\nmalwareB() hijacks succeeded!\n");
    kprintf("\nNow, myprogA will continue running and printing its stack parameters.\n");
    kprintf("\nThe stack parameters would remain the same as before.\n\n");


    /*
     * From the assembly code of malwareB.s, I found that %ebx which belongs to callee saved has been modified,
     * so, we should restore it before malwareB() returns.
     * Moreover, we must push the true return address from
     * proctab[ppid].prstkptr + 124 to proctab[ppid].prstkptr + 120,
     * in order to imitate the return situation of sleepms().
     */

    asm volatile ("movl -4(%ebp), %ebx\n\t"     /* Restore the value of the %ebx register   */
                  "movl %ebp, %esp\n\t"         /* Have the stack frame registers restored  */
                  "popl %ebp\n\t"
                  "pushl (%esp)\n\t"            /* Push the true return address from proctab[ppid].prstkptr + 124 to proctab[ppid].prstkptr + 120*/
                  "ret\n\t");                   /* Make a return    */
}
